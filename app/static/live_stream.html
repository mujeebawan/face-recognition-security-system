<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Face Recognition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Compact Header */
        .header {
            background: linear-gradient(90deg, #124877 0%, #0F518B 100%);
            color: white;
            padding: 15px 30px;
            border-bottom: 3px solid #cc9933;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            color: #cc9933;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Layout - Two Columns */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel - Controls */
        .left-panel {
            width: 350px;
            background: #1e293b;
            border-right: 2px solid #cc9933;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Scrollbar styling */
        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: #cc9933;
            border-radius: 4px;
        }

        /* Right Panel - Video */
        .right-panel {
            flex: 1;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #videoStream {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
        }

        .loading {
            position: absolute;
            color: white;
            font-size: 1.2em;
        }

        /* Control Sections */
        .control-section {
            padding: 15px;
            border-bottom: 1px solid #334155;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .section-title {
            color: #cc9933;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-item {
            margin-bottom: 12px;
        }

        .control-item:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            color: #cbd5e1;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            background: #0f172a;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 6px;
            font-size: 0.95em;
        }

        input[type="range"] {
            padding: 0;
            height: 6px;
            cursor: pointer;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-value {
            color: #cc9933;
            font-weight: 700;
            min-width: 30px;
            text-align: right;
        }

        .notice {
            font-size: 0.85em;
            margin-top: 5px;
            min-height: 18px;
        }

        .notice.success {
            color: #10b981;
        }

        .notice.warning {
            color: #f59e0b;
        }

        .notice.error {
            color: #ef4444;
        }

        .notice.info {
            color: #cbd5e1;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        button:last-child {
            margin-bottom: 0;
        }

        .btn-primary {
            background: linear-gradient(90deg, #124877 0%, #0F518B 100%);
            color: white;
            border: 1px solid #cc9933;
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, #0F518B 0%, #124877 100%);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .zoom-status {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #334155;
            margin-bottom: 12px;
            color: #cbd5e1;
        }

        .tip-box {
            background: rgba(204, 153, 51, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #cc9933;
            font-size: 0.85em;
            color: #cbd5e1;
            margin-top: 12px;
        }

        .tip-box strong {
            color: #cc9933;
        }

        /* Legend */
        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e2e8f0;
            font-size: 0.9em;
        }

        .legend-box {
            width: 35px;
            height: 25px;
            border: 2px solid;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-box.known {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
        }

        .legend-box.unknown {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>
    <!-- Compact Header -->
    <div class="header">
        <h1>üé• Live Face Recognition</h1>
        <div class="status-badge">
            <div class="status-dot"></div>
            <span>Live Streaming</span>
        </div>
    </div>

    <!-- Main Two-Column Layout -->
    <div class="main-content">
        <!-- Left Panel - All Controls -->
        <div class="left-panel">

            <!-- Stream Settings -->
            <div class="control-section">
                <div class="section-title">‚öôÔ∏è Stream Settings</div>

                <div class="control-item">
                    <label>üìπ Stream Source</label>
                    <select id="streamSelect">
                        <option value="main">Main Stream (High Quality)</option>
                        <option value="sub">Sub Stream (Lower Quality)</option>
                    </select>
                    <div id="streamNotice" class="notice"></div>
                </div>

                <div class="control-item">
                    <label>üé¨ Performance Mode</label>
                    <select id="qualityMode">
                        <option value="smooth">Smooth (720p @ 65 quality) - Recommended</option>
                        <option value="balanced">Balanced (720p @ 75 quality)</option>
                        <option value="quality">High Quality (1080p @ 70 quality)</option>
                        <option value="max">Maximum (2K @ 80 quality)</option>
                    </select>
                    <div id="qualityNotice" class="notice info">Best for smooth streaming</div>
                </div>

                <div class="control-item">
                    <label>‚ö° Frame Skip</label>
                    <div class="slider-container">
                        <input type="range" id="frameSkip" min="0" max="10" value="0">
                        <span id="frameSkipValue" class="slider-value">0</span>
                    </div>
                    <div id="frameSkipLabel" class="notice info">Process all frames (best quality)</div>
                    <div id="frameSkipNotice" class="notice"></div>
                </div>

                <div class="tip-box">
                    <strong>üí° Tip:</strong> Main + 0 skip = smoothest!
                </div>
            </div>

            <!-- Zoom Control -->
            <div class="control-section">
                <div class="section-title">üîç PTZ Zoom</div>

                <div id="zoomStatus" class="zoom-status">
                    üîç Ready to zoom (3x optical)
                </div>

                <button class="btn-primary" onmousedown="zoomIn()" onmouseup="stopZoom()" ontouchstart="zoomIn()" ontouchend="stopZoom()">
                    ‚ûï Zoom In
                </button>
                <button class="btn-primary" onmousedown="zoomOut()" onmouseup="stopZoom()" ontouchstart="zoomOut()" ontouchend="stopZoom()">
                    ‚ûñ Zoom Out
                </button>

                <div class="control-item">
                    <label>Zoom Speed</label>
                    <div class="slider-container">
                        <input type="range" id="zoomSpeed" min="10" max="100" value="70">
                        <span id="zoomSpeedValue" class="slider-value">70</span>
                    </div>
                </div>

                <div class="tip-box">
                    <strong>‚å®Ô∏è Keys:</strong> <kbd>+</kbd> In | <kbd>-</kbd> Out | <kbd>Space</kbd> Stop
                </div>
            </div>

            <!-- Actions -->
            <div class="control-section">
                <div class="section-title">üé¨ Actions</div>
                <button class="btn-primary" onclick="reloadStream()">üîÑ Reload Stream</button>
                <button class="btn-secondary" onclick="window.location.href='/docs'">üìö API Docs</button>
                <button class="btn-secondary" onclick="window.location.href='/dashboard'">üìä Dashboard</button>
            </div>

            <!-- Detection Legend -->
            <div class="control-section">
                <div class="section-title">üìã Detection Legend</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-box known"></div>
                        <span><strong>Green:</strong> Known Person</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box unknown"></div>
                        <span><strong>Red:</strong> Unknown Person</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Video Stream -->
        <div class="right-panel">
            <div class="loading" id="loadingText" style="display: none;">Loading stream</div>
            <img id="videoStream" alt="Live video stream">
        </div>
    </div>

    <script>
        const streamImg = document.getElementById('videoStream');
        const loadingText = document.getElementById('loadingText');

        // Start stream
        // Quality mode (stored in localStorage)
        let qualityMode = localStorage.getItem('qualityMode') || 'smooth';

        function startStream() {
            // Build stream URL with quality parameter
            const streamUrl = `/api/stream/live?quality=${qualityMode}`;

            streamImg.onerror = function() {
                loadingText.textContent = 'Stream error. Click reload to retry.';
                loadingText.style.display = 'block';
                streamImg.style.display = 'none';
            };

            // Set stream source
            streamImg.src = streamUrl;

            // Show stream immediately (MJPEG streams don't trigger onload properly)
            loadingText.style.display = 'none';
            streamImg.style.display = 'block';
        }

        function reloadStream() {
            streamImg.style.display = 'none';
            loadingText.style.display = 'block';
            loadingText.textContent = 'Loading stream';
            const streamUrl = `/api/stream/live?quality=${qualityMode}&t=` + new Date().getTime();
            streamImg.src = streamUrl;

            // Show stream immediately (MJPEG doesn't trigger onload)
            setTimeout(() => {
                loadingText.style.display = 'none';
                streamImg.style.display = 'block';
            }, 500);
        }

        // Stream Settings
        let currentFrameSkip = 0;
        let currentStreamType = 'main';

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/public/stream-settings');
                if (response.ok) {
                    const data = await response.json();
                    currentFrameSkip = data.frame_skip || 0;
                    currentStreamType = data.stream_channel || 'main';

                    document.getElementById('frameSkip').value = currentFrameSkip;
                    document.getElementById('frameSkipValue').textContent = currentFrameSkip;
                    document.getElementById('streamSelect').value = currentStreamType;
                    document.getElementById('qualityMode').value = qualityMode;
                    updateFrameSkipLabel(currentFrameSkip);
                    updateQualityLabel(qualityMode);
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        function updateQualityLabel(mode) {
            const notice = document.getElementById('qualityNotice');
            if (mode === 'smooth') {
                notice.textContent = '‚úÖ Best for smooth streaming (~25-30 FPS)';
                notice.className = 'notice success';
            } else if (mode === 'balanced') {
                notice.textContent = '‚öñÔ∏è Good quality with smooth playback (~23-27 FPS)';
                notice.className = 'notice info';
            } else if (mode === 'quality') {
                notice.textContent = 'üé¨ High quality, may reduce smoothness (~20-25 FPS)';
                notice.className = 'notice warning';
            } else if (mode === 'max') {
                notice.textContent = '‚ö†Ô∏è Maximum quality, may have stuttering (~15-20 FPS)';
                notice.className = 'notice warning';
            }
        }

        function updateFrameSkipLabel(value) {
            const label = document.getElementById('frameSkipLabel');
            if (value == 0) {
                label.textContent = 'Process all frames (best quality)';
                label.className = 'notice info';
            } else if (value <= 2) {
                label.textContent = `Skip ${value} - high quality`;
                label.className = 'notice info';
            } else if (value <= 5) {
                label.textContent = `Skip ${value} - balanced`;
                label.className = 'notice warning';
            } else {
                label.textContent = `Skip ${value} - lower CPU`;
                label.className = 'notice warning';
            }
        }

        document.getElementById('frameSkip').addEventListener('input', function() {
            const value = parseInt(this.value);
            document.getElementById('frameSkipValue').textContent = value;
            updateFrameSkipLabel(value);
        });

        document.getElementById('frameSkip').addEventListener('change', async function() {
            const value = parseInt(this.value);
            await updateFrameSkipSetting(value);
        });

        async function updateFrameSkipSetting(value) {
            try {
                const notice = document.getElementById('frameSkipNotice');
                notice.textContent = 'Updating...';
                notice.className = 'notice warning';

                const response = await fetch('/api/public/stream-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame_skip: value })
                });

                if (response.ok) {
                    currentFrameSkip = value;
                    notice.textContent = '‚úì Updated! Reloading...';
                    notice.className = 'notice success';
                    setTimeout(() => {
                        reloadStream();
                        notice.textContent = '';
                    }, 1000);
                } else {
                    notice.textContent = '‚ùå Failed';
                    notice.className = 'notice error';
                }
            } catch (error) {
                document.getElementById('frameSkipNotice').textContent = '‚ùå Error';
                document.getElementById('frameSkipNotice').className = 'notice error';
            }
        }

        document.getElementById('streamSelect').addEventListener('change', async function() {
            await updateStreamSetting(this.value);
        });

        // Quality mode change handler
        document.getElementById('qualityMode').addEventListener('change', function() {
            qualityMode = this.value;
            localStorage.setItem('qualityMode', qualityMode);
            updateQualityLabel(qualityMode);

            // Reload stream with new quality
            const notice = document.getElementById('qualityNotice');
            const originalText = notice.textContent;
            notice.textContent = '‚è≥ Applying new quality mode...';
            notice.className = 'notice warning';

            setTimeout(() => {
                reloadStream();
                updateQualityLabel(qualityMode);
            }, 800);
        });

        async function updateStreamSetting(streamType) {
            try {
                const notice = document.getElementById('streamNotice');
                notice.textContent = '‚è≥ Switching...';
                notice.className = 'notice warning';

                const response = await fetch('/api/public/stream-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stream_channel: streamType })
                });

                if (response.ok) {
                    currentStreamType = streamType;
                    notice.textContent = '‚úì Switched! Reloading...';
                    notice.className = 'notice success';
                    setTimeout(() => {
                        reloadStream();
                        notice.textContent = '';
                    }, 1000);
                } else {
                    notice.textContent = '‚ùå Failed';
                    notice.className = 'notice error';
                }
            } catch (error) {
                document.getElementById('streamNotice').textContent = '‚ùå Error';
                document.getElementById('streamNotice').className = 'notice error';
            }
        }

        // PTZ Zoom Control
        async function ptzApiCall(endpoint, method = 'POST', params = {}) {
            try {
                const url = new URL(endpoint, window.location.origin);
                if (method === 'GET' && Object.keys(params).length > 0) {
                    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                }

                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (method === 'POST' && Object.keys(params).length > 0) {
                    options.body = JSON.stringify(params);
                }

                const response = await fetch(url, options);
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('PTZ error:', error);
                return false;
            }
        }

        function showZoomStatus(message, color = '#cbd5e1') {
            const statusEl = document.getElementById('zoomStatus');
            if (statusEl) {
                statusEl.innerHTML = `<span style="color: ${color}">${message}</span>`;
            }
        }

        let zoomInterval = null;
        let isZooming = false;

        async function zoomIn() {
            if (isZooming) return;
            isZooming = true;
            const speed = parseInt(document.getElementById('zoomSpeed').value);
            showZoomStatus('‚è´ Zooming IN...', '#10b981');
            // Initial call awaited for immediate feedback
            await ptzApiCall(`/api/ptz/zoom/in?speed=${speed}`, 'POST');
            // Continuous calls without await (fire and forget for responsiveness)
            zoomInterval = setInterval(() => {
                ptzApiCall(`/api/ptz/zoom/in?speed=${speed}`, 'POST').catch(e => console.warn('Zoom in call failed:', e));
            }, 300);  // Increased from 200ms to 300ms
        }

        async function zoomOut() {
            if (isZooming) return;
            isZooming = true;
            const speed = parseInt(document.getElementById('zoomSpeed').value);
            showZoomStatus('‚è¨ Zooming OUT...', '#f59e0b');
            // Initial call awaited for immediate feedback
            await ptzApiCall(`/api/ptz/zoom/out?speed=${speed}`, 'POST');
            // Continuous calls without await (fire and forget for responsiveness)
            zoomInterval = setInterval(() => {
                ptzApiCall(`/api/ptz/zoom/out?speed=${speed}`, 'POST').catch(e => console.warn('Zoom out call failed:', e));
            }, 300);  // Increased from 200ms to 300ms
        }

        async function stopZoom() {
            if (!isZooming) return;
            if (zoomInterval) {
                clearInterval(zoomInterval);
                zoomInterval = null;
            }
            isZooming = false;
            showZoomStatus('‚èπÔ∏è Stopped', '#94a3b8');
            await ptzApiCall('/api/ptz/zoom/stop', 'POST');
            setTimeout(() => {
                showZoomStatus('üîç Ready to zoom (3x optical)', '#cbd5e1');
            }, 2000);
        }

        document.getElementById('zoomSpeed').addEventListener('input', function() {
            document.getElementById('zoomSpeedValue').textContent = this.value;
        });

        // Keyboard shortcuts
        let keyPressed = new Set();

        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (keyPressed.has(e.key)) return;
            keyPressed.add(e.key);

            switch(e.key) {
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                case '_':
                    e.preventDefault();
                    zoomOut();
                    break;
                case ' ':
                    e.preventDefault();
                    stopZoom();
                    break;
            }
        });

        document.addEventListener('keyup', function(e) {
            keyPressed.delete(e.key);
            if (['+', '=', '-', '_'].includes(e.key)) {
                e.preventDefault();
                stopZoom();
            }
        });

        // Initialize
        window.addEventListener('load', function() {
            console.log('=== Live Stream Page Loaded ===');
            startStream();
            loadCurrentSettings();
        });
    </script>
</body>
</html>
