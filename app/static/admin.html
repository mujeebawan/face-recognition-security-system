<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEA Admin - Wanted Persons Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            padding: 20px 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #f87171;
            border-bottom: 2px solid #334155;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .form-help {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 5px;
        }

        .file-input-wrapper {
            width: 100%;
        }

        .file-input-button {
            background: #334155;
            color: #e2e8f0;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            text-align: center;
            transition: background 0.3s;
            width: 100%;
        }

        .file-input-button:hover {
            background: #475569;
        }

        .file-input-wrapper input[type=file] {
            display: none;
        }

        .file-name {
            margin-top: 10px;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .image-preview {
            margin-top: 15px;
            max-width: 300px;
            border-radius: 8px;
            border: 2px solid #334155;
            display: none;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(220, 38, 38, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #10b981;
            color: white;
        }

        .alert-error {
            background: #ef4444;
            color: white;
        }

        .alert-info {
            background: #3b82f6;
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #334155;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-links {
            margin-top: 20px;
            text-align: center;
        }

        .nav-links a {
            color: #60a5fa;
            text-decoration: none;
            margin: 0 15px;
            font-size: 0.95em;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .warning-box {
            background: #78350f;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .warning-box strong {
            color: #fbbf24;
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #0f172a;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #f87171;
            border-bottom: 2px solid #334155;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
        }

        tr:hover {
            background: #334155;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .person-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #334155;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .btn-danger:hover {
            background: #991b1b;
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f87171;
        }

        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #475569;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
        }

        .btn-secondary:hover {
            background: #334155;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Admin Panel</h1>
        <p>Manage Wanted Persons</p>
    </div>

    <div class="container">
        <div class="warning-box">
            <strong>‚ö†Ô∏è Important:</strong> Only authorized personnel should have access to this panel.
        </div>

        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>

        <div class="card">
            <h2 class="card-title">‚ûï Add Wanted Person</h2>

            <form id="addPersonForm">
                <div class="form-group">
                    <label class="form-label" for="photo">Photo(s) *</label>
                    <div class="file-input-wrapper">
                        <label class="file-input-button" for="photoInput">
                            üìÅ Choose Photo(s)
                        </label>
                        <input type="file" id="photoInput" accept="image/*" multiple required>
                    </div>
                    <div class="file-name" id="fileName">No file selected</div>
                    <img id="imagePreview" class="image-preview" alt="Preview">
                    <p class="form-help">Upload clear face photo (JPG, PNG) - You can select multiple images for better accuracy</p>

                    <!-- Camera Capture Button -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button type="button" class="btn-secondary" onclick="openCameraModal()" style="padding: 10px 20px; background: #475569; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em;">
                            üì∑ OR Capture from Camera
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="cnic">ID Number (CNIC) *</label>
                    <input
                        type="text"
                        id="cnic"
                        class="form-input"
                        placeholder="e.g., 12345-6789012-3"
                        pattern="[0-9]{5}-[0-9]{7}-[0-9]{1}"
                        required
                    >
                    <p class="form-help">Format: 12345-6789012-3</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="name">Full Name *</label>
                    <input
                        type="text"
                        id="name"
                        class="form-input"
                        placeholder="e.g., Abdul Rasheed Khan"
                        required
                    >
                    <p class="form-help">Enter full name</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes">Case Notes (Optional)</label>
                    <textarea
                        id="notes"
                        class="form-input"
                        rows="3"
                        placeholder="e.g., Wanted for theft case #12345, high priority"
                    ></textarea>
                    <p class="form-help">Add any relevant case information</p>
                </div>

                <!-- AI Augmentation Toggle -->
                <div class="form-group" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 12px; border: 2px solid #334155;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="useSDaugmentation" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <label for="useSDaugmentation" style="font-size: 1.1em; color: #fbbf24; margin: 0; cursor: pointer; font-weight: 600;">
                            ‚ú® Use AI Augmentation (Recommended for Single Photo)
                        </label>
                    </div>
                    <p class="form-help" style="margin: 0 0 15px 32px; color: #94a3b8;">
                        Generates 5-10 synthetic face angles using Stable Diffusion AI to improve recognition accuracy.
                        <strong style="color: #60a5fa;">Takes 10-15 seconds but significantly improves accuracy!</strong>
                    </p>

                    <div id="sdOptions" style="display: none; margin-left: 32px;">
                        <label class="form-label" for="numVariations" style="font-size: 0.95em;">Number of AI-generated angles:</label>
                        <input type="range" id="numVariations" min="3" max="10" value="5" style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #94a3b8; margin-bottom: 15px;">
                            <span>3 (Faster ~6s)</span>
                            <span id="numVariationsValue" style="color: #fbbf24; font-weight: 600;">5 variations</span>
                            <span>10 (Best ~20s)</span>
                        </div>
                        <p class="form-help" style="margin: 0; font-size: 0.85em; color: #cbd5e1;">
                            üí° <strong>Tip:</strong> 5 variations provides excellent balance between speed and accuracy.
                            Use 8-10 for critical cases.
                        </p>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText" style="margin-top: 10px;">Processing... This may take 5-10 seconds</p>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    ‚ûï Add Wanted Person
                </button>
            </form>
        </div>

        <!-- Wanted Persons List -->
        <div class="card">
            <h2 class="card-title">üë• Wanted Persons List</h2>

            <!-- Search Box -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label" for="searchCNIC">üîç Search by ID Number (CNIC)</label>
                <input
                    type="text"
                    id="searchCNIC"
                    class="form-input"
                    placeholder="e.g., 12345-6789012-3"
                    onkeyup="searchPersons()"
                >
                <p class="form-help">Type ID number to search - matching person will appear at top</p>
            </div>

            <div id="personsTableContainer">
                <div class="loading" id="tableLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">Loading...</p>
                </div>

                <div class="table-container" id="tableWrapper" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>ID Number (CNIC)</th>
                                <th>Added On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="personsTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üì≠</div>
                    <h3>No Wanted Persons</h3>
                    <p>Add a wanted person using the form above to get started.</p>
                </div>
            </div>
        </div>

        <div class="nav-links">
            <a href="/dashboard">üìä View Dashboard</a>
            <a href="/live">üìπ Live Stream</a>
            <a href="/docs">üìñ API Documentation</a>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Confirm Removal</div>
            <div class="modal-body" id="modalBody">
                Are you sure you want to remove this person from the wanted list?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmRemoveBtn">Remove</button>
            </div>
        </div>
    </div>

    <!-- Camera Capture Modal -->
    <div class="modal" id="cameraModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">üì∑ Capture from Live Camera</div>
            <div class="modal-body">
                <!-- Live Stream (Fast MJPEG Preview) -->
                <div style="text-align: center; position: relative;">
                    <img id="liveStream" style="max-width: 100%; border-radius: 8px; border: 2px solid #334155; margin-bottom: 15px;" alt="Live Camera Preview">
                    <p style="color: #94a3b8; font-size: 0.9em; margin-top: 10px;">
                        üìπ Live camera preview (raw sub-stream, ~15-20 FPS) - Position the person in the frame
                    </p>
                </div>

                <!-- Captured Images Preview -->
                <div id="capturedImagesContainer" style="display: none; margin-top: 20px;">
                    <h3 style="color: #f87171; font-size: 1.1em; margin-bottom: 10px;">‚úì Captured Images:</h3>
                    <div id="capturedImagesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Captured images will appear here -->
                    </div>
                </div>

                <!-- Angle Selection (shown after first capture) -->
                <div id="angleSelection" style="display: none; margin-top: 20px; padding: 15px; background: #0f172a; border-radius: 8px; border: 2px solid #334155;">
                    <h3 style="color: #fbbf24; font-size: 1em; margin-bottom: 10px;">üìê Capture more angles? (Recommended for better accuracy)</h3>
                    <p style="color: #94a3b8; font-size: 0.85em; margin-bottom: 10px;">
                        Multiple angles significantly improve recognition accuracy
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="setAngleHint('frontal')" class="angle-btn" style="flex: 1; min-width: 100px; padding: 8px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            üòê Frontal
                        </button>
                        <button onclick="setAngleHint('left')" class="angle-btn" style="flex: 1; min-width: 100px; padding: 8px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            ‚óÄÔ∏è Looking Left
                        </button>
                        <button onclick="setAngleHint('right')" class="angle-btn" style="flex: 1; min-width: 100px; padding: 8px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            ‚ñ∂Ô∏è Looking Right
                        </button>
                        <button onclick="setAngleHint('up')" class="angle-btn" style="flex: 1; min-width: 100px; padding: 8px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            ‚¨ÜÔ∏è Looking Up
                        </button>
                        <button onclick="setAngleHint('down')" class="angle-btn" style="flex: 1; min-width: 100px; padding: 8px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            ‚¨áÔ∏è Looking Down
                        </button>
                    </div>
                    <p id="angleHint" style="color: #60a5fa; font-size: 0.9em; margin-top: 10px; text-align: center; display: none;">
                        <!-- Angle hint will appear here -->
                    </p>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 10px;">
                <div style="display: flex; width: 100%; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeCameraModal()" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="captureFromCamera()" id="captureBtn" style="flex: 2;">
                        üì∏ Capture Current Frame
                    </button>
                </div>
                <button class="btn btn-primary" onclick="finishCapture()" id="finishBtn" style="display: none; width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ‚úì Done - Use These Images (<span id="imageCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- Person Details Modal -->
    <div class="modal" id="personDetailsModal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <span>üë§ Person Details</span>
                    <button class="btn btn-secondary" onclick="closePersonDetailsModal()" style="padding: 5px 15px;">√ó</button>
                </div>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Person Info -->
                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 id="detailsPersonName" style="margin: 0 0 10px 0; color: #60a5fa;">Loading...</h3>
                    <p style="margin: 5px 0;"><strong>CNIC:</strong> <span id="detailsPersonCnic">-</span></p>
                    <p style="margin: 5px 0;"><strong>Enrolled:</strong> <span id="detailsPersonEnrolled">-</span></p>
                    <p style="margin: 5px 0;"><strong>Total Embeddings:</strong> <span id="detailsTotalEmbeddings">-</span></p>
                </div>

                <!-- Images Grid -->
                <div>
                    <h4 style="margin: 0 0 15px 0; color: #fbbf24;">üì∏ Enrolled Photos</h4>
                    <div id="detailsImagesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Images will be populated here -->
                    </div>
                </div>

                <!-- Embeddings List -->
                <div style="margin-top: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #a78bfa;">üß† Face Embeddings</h4>
                    <div id="detailsEmbeddingsList" style="background: #1e293b; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                        <!-- Embeddings will be populated here -->
                    </div>
                </div>

                <!-- Case Notes / Alerts -->
                <div style="margin-top: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #ef4444;">üö® Case History & Alerts</h4>
                    <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; color: #fbbf24;">üìä</div>
                                <div style="font-size: 0.9em; color: #94a3b8;">Total Detections</div>
                                <div id="detailsRecognitionCount" style="font-size: 1.5em; color: #60a5fa; font-weight: bold;">-</div>
                            </div>
                            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; color: #ef4444;">‚ö†Ô∏è</div>
                                <div style="font-size: 0.9em; color: #94a3b8;">Total Alerts</div>
                                <div id="detailsTotalAlerts" style="font-size: 1.5em; color: #ef4444; font-weight: bold;">-</div>
                            </div>
                            <div style="background: #0f172a; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; color: #10b981;">‚úì</div>
                                <div style="font-size: 0.9em; color: #94a3b8;">Embeddings</div>
                                <div id="detailsEmbeddingsCount" style="font-size: 1.5em; color: #10b981; font-weight: bold;">-</div>
                            </div>
                        </div>
                        <div id="detailsAlertsList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePersonDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // File input handling
        const photoInput = document.getElementById('photoInput');
        const fileName = document.getElementById('fileName');
        const imagePreview = document.getElementById('imagePreview');

        photoInput.addEventListener('change', function(e) {
            if (this.files && this.files.length > 0) {
                const fileCount = this.files.length;
                const totalSize = Array.from(this.files).reduce((sum, f) => sum + f.size, 0);

                if (fileCount === 1) {
                    fileName.textContent = `Selected: ${this.files[0].name} (${(this.files[0].size / 1024).toFixed(1)} KB)`;
                } else {
                    fileName.textContent = `Selected: ${fileCount} images (${(totalSize / 1024).toFixed(1)} KB total)`;
                }

                // Show preview of first image
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // CNIC formatting
        const cnicInput = document.getElementById('cnic');
        cnicInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');

            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5);
            }
            if (value.length > 13) {
                value = value.slice(0, 13) + '-' + value.slice(13);
            }
            if (value.length > 15) {
                value = value.slice(0, 15);
            }

            e.target.value = value;
        });

        // Form submission
        const form = document.getElementById('addPersonForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');

        // SD Augmentation UI Controls
        const useSDCheckbox = document.getElementById('useSDaugmentation');
        const sdOptions = document.getElementById('sdOptions');
        const numVariationsSlider = document.getElementById('numVariations');
        const numVariationsValue = document.getElementById('numVariationsValue');

        // Toggle SD options visibility
        useSDCheckbox.addEventListener('change', function() {
            sdOptions.style.display = this.checked ? 'block' : 'none';
        });

        // Update slider value display
        numVariationsSlider.addEventListener('input', function() {
            numVariationsValue.textContent = `${this.value} variations`;
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Hide previous alerts
            successAlert.style.display = 'none';
            errorAlert.style.display = 'none';

            // Get form data
            const files = photoInput.files;
            const cnic = document.getElementById('cnic').value;
            const name = document.getElementById('name').value;
            const notes = document.getElementById('notes').value;
            const useSD = useSDCheckbox.checked;
            const numVariations = parseInt(numVariationsSlider.value);

            if (!files || files.length === 0) {
                showError('Please select at least one photo');
                return;
            }

            // Show loading with appropriate message
            submitBtn.disabled = true;
            loading.style.display = 'block';

            if (useSD && files.length === 1) {
                loadingText.textContent = `‚è≥ Generating ${numVariations} AI angles... This will take ~${Math.ceil(numVariations * 2.5)}s`;
            } else {
                loadingText.textContent = 'Processing... This may take 5-10 seconds';
            }

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('name', name);
                formData.append('cnic', cnic);

                let endpoint, successMessage;

                if (files.length === 1) {
                    // Single image enrollment
                    formData.append('file', files[0]);
                    formData.append('use_sd_augmentation', useSD ? 'true' : 'false');
                    formData.append('num_sd_variations', numVariations.toString());
                    endpoint = '/api/enroll';
                    successMessage = useSD
                        ? `‚úÖ Successfully enrolled "${name}" with AI augmentation (${numVariations + 1} total embeddings)!`
                        : `‚úÖ Successfully enrolled "${name}" with 1 image!`;
                } else {
                    // Multiple images enrollment (use traditional augmentation)
                    for (let i = 0; i < files.length; i++) {
                        formData.append('files', files[i]);
                    }
                    formData.append('use_augmentation', 'true'); // Traditional augmentation
                    endpoint = '/api/enroll/multiple';
                    successMessage = `‚úÖ Successfully enrolled "${name}" with ${files.length} images!`;
                }

                // Call API
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Enhanced success message with timing
                    if (useSD && data.sd_generation_time) {
                        successMessage += ` (AI generation: ${data.sd_generation_time}s, avg: ${data.avg_time_per_image}s per image)`;
                    }
                    showSuccess(successMessage);
                    form.reset();
                    fileName.textContent = 'No file selected';
                    imagePreview.style.display = 'none';
                    sdOptions.style.display = 'none'; // Hide SD options
                } else {
                    showError(data.detail || data.message || 'Failed to enroll person');
                }

            } catch (error) {
                console.error('Error:', error);
                showError('Network error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                loading.style.display = 'none';
                loadingText.textContent = 'Processing... This may take 5-10 seconds';
            }
        });

        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showError(message) {
            errorAlert.textContent = '‚ùå Error: ' + message;
            errorAlert.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== WANTED PERSONS TABLE =====

        let personsData = [];
        let personToRemove = null;

        // Load wanted persons list
        async function loadWantedPersons() {
            const tableLoading = document.getElementById('tableLoading');
            const tableWrapper = document.getElementById('tableWrapper');
            const emptyState = document.getElementById('emptyState');

            tableLoading.style.display = 'block';
            tableWrapper.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                const response = await fetch('/api/persons');
                const data = await response.json();

                if (response.ok) {
                    personsData = data.persons || [];
                    displayWantedPersons();
                } else {
                    console.error('Failed to load persons:', data);
                    showError('Failed to load wanted persons list');
                }
            } catch (error) {
                console.error('Error loading persons:', error);
                showError('Network error loading persons');
            } finally {
                tableLoading.style.display = 'none';
            }
        }

        // Search persons by CNIC
        function searchPersons() {
            const searchInput = document.getElementById('searchCNIC').value.toLowerCase().trim();

            if (!searchInput) {
                // No search - show all in original order
                displayWantedPersons();
                return;
            }

            // Filter and sort: exact matches first, then partial matches
            const filtered = personsData.filter(person =>
                person.cnic.toLowerCase().includes(searchInput)
            );

            const sorted = filtered.sort((a, b) => {
                const aStarts = a.cnic.toLowerCase().startsWith(searchInput);
                const bStarts = b.cnic.toLowerCase().startsWith(searchInput);

                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                return 0;
            });

            displayWantedPersons(sorted);
        }

        // Display persons in table
        function displayWantedPersons(dataToDisplay = null) {
            const tableWrapper = document.getElementById('tableWrapper');
            const emptyState = document.getElementById('emptyState');
            const tableBody = document.getElementById('personsTableBody');

            const data = dataToDisplay || personsData;

            if (data.length === 0) {
                tableWrapper.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">üîç</div>
                    <h3>No Results Found</h3>
                    <p>No person found with that ID number.</p>
                `;
                return;
            }

            if (personsData.length === 0) {
                tableWrapper.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">üì≠</div>
                    <h3>No Wanted Persons</h3>
                    <p>Add a wanted person using the form above to get started.</p>
                `;
                return;
            }

            tableWrapper.style.display = 'block';
            emptyState.style.display = 'none';

            const searchInput = document.getElementById('searchCNIC').value.toLowerCase().trim();

            tableBody.innerHTML = data.map((person, index) => {
                const enrolledDate = new Date(person.enrolled_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Show actual original photo with cache-busting timestamp
                const photoHTML = person.reference_image_path
                    ? `<img src="/api/image/${person.cnic}/original?t=${Date.now()}" class="person-photo" alt="${person.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #334155;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23334155%22 width=%2260%22 height=%2260%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2224%22 fill=%22%23cbd5e1%22 text-anchor=%22middle%22 dy=%22.3em%22%3E${person.name.charAt(0)}%3C/text%3E%3C/svg%3E'">`
                    : `<div style="width: 60px; height: 60px; background: #334155; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #cbd5e1;">${person.name.charAt(0)}</div>`;

                // Highlight matching CNIC
                const isMatch = searchInput && person.cnic.toLowerCase().includes(searchInput);
                const rowStyle = isMatch && index === 0 ? 'background: #1e40af;' : '';

                return `
                    <tr data-person-id="${person.id}" style="${rowStyle}">
                        <td>${photoHTML}</td>
                        <td><strong>${person.name}</strong></td>
                        <td>${person.cnic}</td>
                        <td>${enrolledDate}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn-secondary" onclick="viewPersonDetails(${person.id})" style="padding: 8px 12px; background: #475569; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.9em; margin-right: 8px;">
                                üëÅÔ∏è View
                            </button>
                            <button class="btn-danger" onclick="confirmRemovePerson(${person.id}, '${person.name}')" style="padding: 8px 12px; background: #dc2626; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 0.9em;">
                                üóëÔ∏è Remove
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Confirm removal
        function confirmRemovePerson(id, name) {
            personToRemove = { id, name };
            const modal = document.getElementById('confirmModal');
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `
                Are you sure you want to remove <strong>${name}</strong> from the wanted list?<br>
                <small style="color: #94a3b8;">This action cannot be undone.</small>
            `;

            modal.classList.add('active');
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('active');
            personToRemove = null;
        }

        // Remove person
        document.getElementById('confirmRemoveBtn').addEventListener('click', async function() {
            if (!personToRemove) return;

            const { id, name } = personToRemove;
            const btn = this;

            btn.disabled = true;
            btn.textContent = 'Removing...';

            try {
                const response = await fetch(`/api/persons/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Remove from local data
                    personsData = personsData.filter(p => p.id !== id);

                    // Update table
                    displayWantedPersons();

                    // Close modal
                    closeModal();

                    // Show success
                    showSuccess(`‚úÖ Successfully removed "${name}" from wanted list!`);
                } else {
                    showError(data.detail || data.message || 'Failed to remove person');
                }
            } catch (error) {
                console.error('Error removing person:', error);
                showError('Network error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Remove';
            }
        });

        // Close modal when clicking outside
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Load wanted persons on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadWantedPersons();
        });

        // Reload table after adding new person
        const originalFormSubmit = form.onsubmit;
        form.addEventListener('submit', async function(e) {
            // Let original handler run first
            await new Promise(resolve => setTimeout(resolve, 100));

            // After successful add, reload table
            setTimeout(() => {
                loadWantedPersons();
            }, 2000);
        });

        // Camera capture functionality
        let capturedImages = [];
        let currentAngle = 'frontal';

        function openCameraModal() {
            const modal = document.getElementById('cameraModal');
            const liveStream = document.getElementById('liveStream');

            modal.style.display = 'flex';

            // Reset state
            capturedImages = [];
            currentAngle = 'frontal';
            document.getElementById('capturedImagesContainer').style.display = 'none';
            document.getElementById('angleSelection').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
            document.getElementById('capturedImagesGrid').innerHTML = '';
            document.getElementById('imageCount').textContent = '0';

            // Set MJPEG stream source (smooth, continuous stream ~15-20 FPS)
            // Add timestamp to prevent browser caching
            liveStream.src = `/api/stream/preview?t=${Date.now()}`;
        }

        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            const liveStream = document.getElementById('liveStream');

            modal.style.display = 'none';

            // Stop MJPEG stream
            liveStream.src = '';

            // Clean up captured images
            capturedImages.forEach(img => URL.revokeObjectURL(img.url));
            capturedImages = [];
        }

        function setAngleHint(angle) {
            currentAngle = angle;
            const hint = document.getElementById('angleHint');
            const angleNames = {
                'frontal': 'üòê Ask person to look straight at the camera',
                'left': '‚óÄÔ∏è Ask person to turn their head LEFT',
                'right': '‚ñ∂Ô∏è Ask person to turn their head RIGHT',
                'up': '‚¨ÜÔ∏è Ask person to tilt their head UP',
                'down': '‚¨áÔ∏è Ask person to tilt their head DOWN'
            };
            hint.textContent = angleNames[angle];
            hint.style.display = 'block';

            // Highlight selected button
            document.querySelectorAll('.angle-btn').forEach(btn => {
                btn.style.background = '#334155';
            });
            event.target.style.background = '#dc2626';
        }

        async function captureFromCamera() {
            try {
                // Fetch current frame from sub-stream (fast, no processing)
                // Add timestamp to prevent caching
                const response = await fetch(`/api/camera/snapshot?draw_detections=false&t=${Date.now()}`);
                const blob = await response.blob();

                // Create object URL for preview
                const url = URL.createObjectURL(blob);

                // Add to captured images array
                capturedImages.push({
                    blob: blob,
                    url: url,
                    angle: currentAngle,
                    filename: `camera_${currentAngle}_${Date.now()}.jpg`
                });

                // Update UI
                updateCapturedImagesDisplay();

                // Show angle selection after first capture
                document.getElementById('angleSelection').style.display = 'block';
                document.getElementById('finishBtn').style.display = 'block';

                // Show success feedback
                const captureBtn = document.getElementById('captureBtn');
                const originalText = captureBtn.innerHTML;
                captureBtn.innerHTML = '‚úì Captured!';
                captureBtn.style.background = '#10b981';
                setTimeout(() => {
                    captureBtn.innerHTML = originalText;
                    captureBtn.style.background = '';
                }, 1000);

            } catch (error) {
                console.error('Error capturing frame:', error);
                alert('Failed to capture frame. Please try again.');
            }
        }

        function updateCapturedImagesDisplay() {
            const container = document.getElementById('capturedImagesContainer');
            const grid = document.getElementById('capturedImagesGrid');
            const imageCount = document.getElementById('imageCount');

            container.style.display = 'block';
            grid.innerHTML = '';

            capturedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative; border: 2px solid #334155; border-radius: 8px; overflow: hidden;';
                div.innerHTML = `
                    <img src="${img.url}" style="width: 100%; height: 150px; object-fit: cover;">
                    <div style="background: #0f172a; padding: 5px; text-align: center; font-size: 0.8em;">
                        ${img.angle}
                    </div>
                    <button onclick="removeImage(${index})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.8em;">
                        ‚úï
                    </button>
                `;
                grid.appendChild(div);
            });

            imageCount.textContent = capturedImages.length;
        }

        function removeImage(index) {
            URL.revokeObjectURL(capturedImages[index].url);
            capturedImages.splice(index, 1);
            updateCapturedImagesDisplay();

            if (capturedImages.length === 0) {
                document.getElementById('capturedImagesContainer').style.display = 'none';
                document.getElementById('angleSelection').style.display = 'none';
                document.getElementById('finishBtn').style.display = 'none';
            }
        }

        async function finishCapture() {
            if (capturedImages.length === 0) {
                alert('Please capture at least one image');
                return;
            }

            // Check if using /api/enroll/multiple endpoint (supports multiple images)
            // If only 1 image, use regular /api/enroll

            if (capturedImages.length === 1) {
                // Single image - use regular file input
                const file = new File([capturedImages[0].blob], capturedImages[0].filename, { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                photoInput.files = dataTransfer.files;

                const event = new Event('change', { bubbles: true });
                photoInput.dispatchEvent(event);
            } else {
                // Multiple images - set all files to input (for multi-image enrollment)
                const dataTransfer = new DataTransfer();
                capturedImages.forEach(img => {
                    const file = new File([img.blob], img.filename, { type: 'image/jpeg' });
                    dataTransfer.items.add(file);
                });
                photoInput.files = dataTransfer.files;

                // Update file name display
                fileName.textContent = `${capturedImages.length} images captured`;

                // Show preview of first image
                imagePreview.src = capturedImages[0].url;
                imagePreview.style.display = 'block';
            }

            closeCameraModal();
        }

        // Close camera modal when clicking outside
        document.getElementById('cameraModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCameraModal();
            }
        });

        // Person Details Modal Functions
        async function showPersonDetails(personId) {
            const modal = document.getElementById('personDetailsModal');
            modal.style.display = 'flex';

            try {
                const response = await fetch(`/api/persons/${personId}`);
                const data = await response.json();

                if (data.success) {
                    // Populate person info
                    document.getElementById('detailsPersonName').textContent = data.person.name;
                    document.getElementById('detailsPersonCnic').textContent = data.person.cnic;
                    document.getElementById('detailsPersonEnrolled').textContent = new Date(data.person.enrolled_at).toLocaleString();
                    document.getElementById('detailsTotalEmbeddings').textContent = data.total_embeddings;

                    // Populate stats
                    document.getElementById('detailsRecognitionCount').textContent = data.recognition_count || 0;
                    document.getElementById('detailsTotalAlerts').textContent = data.total_alerts || 0;
                    document.getElementById('detailsEmbeddingsCount').textContent = data.total_embeddings;

                    // Populate images grid
                    const imagesGrid = document.getElementById('detailsImagesGrid');
                    imagesGrid.innerHTML = '';

                    data.images.forEach((img, index) => {
                        const imageCard = document.createElement('div');
                        imageCard.style.cssText = 'background: #1e293b; border-radius: 12px; overflow: hidden; border: 2px solid #334155; transition: transform 0.2s;';
                        // Add cache-busting timestamp to image URLs
                        const imageUrlWithTimestamp = `${img.url}?t=${Date.now()}`;
                        imageCard.innerHTML = `
                            <img src="${imageUrlWithTimestamp}" alt="${img.source}" style="width: 100%; height: 180px; object-fit: cover;">
                            <div style="padding: 10px;">
                                <p style="margin: 0; font-size: 0.9em; color: #60a5fa;">
                                    ${img.source === 'original' ? 'üì∑ Original' : '‚ú® AI Generated #' + img.source.split('_').pop()}
                                </p>
                                ${img.confidence ? `<p style="margin: 5px 0 0 0; font-size: 0.8em; color: #94a3b8;">Confidence: ${(img.confidence * 100).toFixed(1)}%</p>` : ''}
                            </div>
                        `;
                        imageCard.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
                        imageCard.onmouseout = function() { this.style.transform = 'scale(1)'; };
                        imagesGrid.appendChild(imageCard);
                    });

                    // Populate embeddings list
                    const embeddingsList = document.getElementById('detailsEmbeddingsList');
                    embeddingsList.innerHTML = '';

                    data.embeddings.forEach((emb, index) => {
                        const embDiv = document.createElement('div');
                        embDiv.style.cssText = 'background: #0f172a; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #60a5fa;';
                        embDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #fbbf24;">#${index + 1}</strong>
                                    <span style="color: #94a3b8; margin-left: 10px;">${emb.source}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #10b981;">Confidence: ${(emb.confidence * 100).toFixed(1)}%</div>
                                    <div style="color: #64748b; font-size: 0.8em;">${new Date(emb.created_at).toLocaleString()}</div>
                                </div>
                            </div>
                        `;
                        embeddingsList.appendChild(embDiv);
                    });

                    // Populate alerts/case history
                    const alertsList = document.getElementById('detailsAlertsList');
                    alertsList.innerHTML = '';

                    if (data.alerts && data.alerts.length > 0) {
                        data.alerts.forEach((alert, index) => {
                            const alertDiv = document.createElement('div');
                            const eventColor = alert.event_type === 'known_person' ? '#10b981' : '#ef4444';
                            const eventIcon = alert.event_type === 'known_person' ? '‚úì' : '‚ö†Ô∏è';
                            const statusBadge = alert.acknowledged
                                ? '<span style="background: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">‚úì Acknowledged</span>'
                                : '<span style="background: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">‚ö† Pending</span>';

                            alertDiv.style.cssText = 'background: #0f172a; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ' + eventColor + ';';
                            alertDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                            <span style="font-size: 1.2em;">${eventIcon}</span>
                                            <strong style="color: ${eventColor};">${alert.event_type.replace('_', ' ').toUpperCase()}</strong>
                                            ${statusBadge}
                                        </div>
                                        <div style="color: #94a3b8; font-size: 0.9em;">
                                            <div>üìÖ ${new Date(alert.timestamp).toLocaleString()}</div>
                                            ${alert.confidence ? `<div>üéØ Confidence: ${(alert.confidence * 100).toFixed(1)}%</div>` : ''}
                                            ${alert.acknowledged_by ? `<div>üë§ Acknowledged by: ${alert.acknowledged_by}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ${alert.notes ? `<div style="background: #1e293b; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.9em; color: #cbd5e1;"><strong>Notes:</strong> ${alert.notes}</div>` : ''}
                            `;
                            alertsList.appendChild(alertDiv);
                        });
                    } else {
                        alertsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">No alerts or case history found</div>';
                    }

                } else {
                    alert('Failed to load person details');
                    closePersonDetailsModal();
                }
            } catch (error) {
                console.error('Error fetching person details:', error);
                alert('Failed to load person details');
                closePersonDetailsModal();
            }
        }

        function closePersonDetailsModal() {
            document.getElementById('personDetailsModal').style.display = 'none';
        }

        // Wrapper function for viewing person details from the View button
        function viewPersonDetails(personId) {
            showPersonDetails(personId);
        }

        // Make person rows in search results clickable
        function makePersonRowsClickable() {
            const personRows = document.querySelectorAll('#enrolledPersonsTable tbody tr');
            personRows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking remove button
                    if (!e.target.classList.contains('btn-danger')) {
                        const personId = this.dataset.personId;
                        if (personId) {
                            showPersonDetails(personId);
                        }
                    }
                });
            });
        }

    </script>
</body>
</html>
